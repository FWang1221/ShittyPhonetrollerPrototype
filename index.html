<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Sender with Rate Control Websocket Edition</title>
</head>
<body>
    <h1>Data Sender with Rate Control Websocket Edition</h1>
    <p>Your phone will send data to the server at the rate specified below.</p>
    <p id="error" style="color: red;"></p>

    <label for="serverAddress">Server Address:</label>
    <input type="text" id="serverAddress" placeholder="ws://example.com:7777">
    <button id="submitAddress">Set Address</button>

    <h2>Send Rate</h2>
    <label for="rateSlider">Rate (times per second): <span id="rateValue">10</span></label>
    <input type="range" id="rateSlider" min="3" max="40" value="10">

    <h2>Calibration</h2>
    <button id="calibrateButton">Calibrate</button>
    <p>Calibrated Offset: <span id="calibrationOffset">Alpha: N/A | Beta: N/A | Gamma: N/A</span></p>

    <h2>Data</h2>
    <p id="data">Alpha: N/A | Beta: N/A | Gamma: N/A</p>

    <!-- Custom Message Section -->
    <h2>Send Custom Message</h2>
    <label for="customMessage">Message:</label>
    <input type="text" id="customMessage" placeholder="kv=4:8000000">
    <br><br>
    <button id="sendMessageButton">Send Message</button>

    <script>
        let serverAddress = '';
        let lastSent = 0;
        let maxRate = 1000 / 10; // Initial rate: 10 messages per second

        let calibration = { alpha: 0, beta: 0, gamma: 0 };
        let calibrated = false;

        let ws;

        document.getElementById('submitAddress').addEventListener('click', function() {
            serverAddress = document.getElementById('serverAddress').value.trim();
            if (!serverAddress) {
                document.getElementById('error').textContent = 'Please enter a valid server address.';
                return;
            }

            if (ws) {
                ws.close();
            }

            ws = new WebSocket(serverAddress);

            ws.onopen = function() {
                document.getElementById('error').textContent = '';
                console.log('WebSocket connection established:', serverAddress);
            };

            ws.onmessage = function(event) {
                console.log('Server response:', event.data);
                document.getElementById('error').textContent = ''; // Clear any previous error messages
            };

            ws.onclose = function(event) {
                console.log('WebSocket connection closed', event);
                document.getElementById('error').textContent = 'WebSocket connection closed.';
            };

            ws.onerror = function(event) {
                console.log('WebSocket error occurred', event);
                document.getElementById('error').textContent = 'WebSocket error occurred.';
            };
        });

        document.getElementById('rateSlider').addEventListener('input', function() {
            const rate = this.value;
            document.getElementById('rateValue').textContent = rate;
            maxRate = 1000 / rate; // Calculate the interval based on the rate
        });

        document.getElementById('calibrateButton').addEventListener('click', function() {
            calibration.alpha = currentAlpha;
            calibration.beta = currentBeta;
            calibration.gamma = currentGamma;
            calibrated = true;

            document.getElementById('calibrationOffset').textContent = `Alpha: ${calibration.alpha} | Beta: ${calibration.beta} | Gamma: ${calibration.gamma}`;
            console.log('Calibration set:', calibration);
        });

        document.getElementById('sendMessageButton').addEventListener('click', function() {
            const customMessage = document.getElementById('customMessage').value.trim();
            if (!customMessage) {
                document.getElementById('error').textContent = 'Please enter a message to send.';
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                document.getElementById('error').textContent = 'WebSocket connection is not open.';
                return;
            }

            ws.send(customMessage);
            console.log('Sent custom message:', customMessage);
        });

        let currentAlpha = 0, currentBeta = 0, currentGamma = 0;

        function formatKeyValuePairs(alpha, beta, gamma) {
            const pairs = [
                `kv=1:${alpha}`,
                `kv=2:${beta}`,
                `kv=3:${gamma}`
            ];
            return pairs.join('&');
        }

        function sendData(alpha, beta, gamma) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                document.getElementById('error').textContent = 'WebSocket connection is not open.';
                return;
            }

            const message = formatKeyValuePairs(alpha, beta, gamma);

            ws.send(message);
        }

        function handleData(event) {
            const currentTime = Date.now();
            if (currentTime - lastSent >= maxRate) {
                lastSent = currentTime;

                currentAlpha = event.alpha ? event.alpha.toFixed(2) : 0;
                currentBeta = event.beta ? event.beta.toFixed(2) : 0;
                currentGamma = event.gamma ? event.gamma.toFixed(2) : 0;

                let adjustedAlpha = currentAlpha;
                let adjustedBeta = currentBeta;
                let adjustedGamma = currentGamma;

                if (calibrated) {
                    adjustedAlpha = (currentAlpha - calibration.alpha).toFixed(2);
                    adjustedBeta = (currentBeta - calibration.beta).toFixed(2);
                    adjustedGamma = (currentGamma - calibration.gamma).toFixed(2);
                }

                document.getElementById('data').textContent = `Alpha: ${adjustedAlpha} | Beta: ${adjustedBeta} | Gamma: ${adjustedGamma}`;

                sendData(adjustedAlpha, adjustedBeta, adjustedGamma);
            }
        }

        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', handleData, false);
        } else {
            document.getElementById('error').textContent = 'DeviceOrientationEvent is not supported';
        }
    </script>
</body>
</html>
